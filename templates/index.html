<!-- templates/index.html -->
<!DOCTYPE html>
<html>
  <head>
    <title>Powerful Owl Finder</title>
  </head>
  <body>
    <h1>Listening for Powerful Owls? ðŸ¦‰</h1>
    <form id="owlsForm" action="/stream_predict" method="post" enctype="multipart/form-data">
        <label for="file">Choose an audio file:</label>
        <input type="file" id="file" name="file" accept="audio/*">
        <input type="submit" value="Upload and look for owls (stream response, currently broken)">
    </form>
    <hr>
    <div id="results"></div>
  <script>
    // Intercept form submission and render the server-sent events
    document.getElementById('owlsForm').addEventListener('submit', function(e) {
        e.preventDefault(); // Prevents default form submission
        var formData = new FormData(this);
        submitForm(formData);
    });

    function submitForm(formData) {
        document.getElementById('results').innerHTML = 'Loading...';

        fetch('/stream_predict', {
            method: 'POST',
            body: formData,
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            document.getElementById('results').innerHTML = '';
            return response.body;
        })
        .then(stream => {
            // Handle the stream
            const reader = stream.getReader();
            readStream(reader);
        })
        .catch(error => {
            console.error('Error:', error);
        });
    }

    function readStream(reader) {
        reader.read().then(({ done, value }) => {
            if (done) {
                console.log('Stream complete');
                return;
            }
            // Process the chunk (value)
            // For text streams, you can decode the value to a string
            const decoder = new TextDecoder();
            const text = decoder.decode(value);
            console.log(text);
            // Optionally, update the DOM here
            document.getElementById('results').innerHTML += text;
            // Read the next chunk
            readStream(reader);
        });
    }
  </script>
  </body>
</html>