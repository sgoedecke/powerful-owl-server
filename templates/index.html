<!-- templates/index.html -->
<!DOCTYPE html>
<html>
  <head>
    <title>Powerful Owl Finder</title>
  </head>
  <body style="padding-left: 20px; padding-right: 20px;">
    <h1>Listening for Powerful Owls? ðŸ¦‰</h1>
    <form id="owlsForm" action="/stream_predict" method="post" enctype="multipart/form-data">
        <label for="file">Choose an audio file:</label>
        <input type="file" id="file" name="file" accept="audio/*">
        <input type="submit" value="Upload and look for owls">
    </form>
    <hr>
    <div id="results"></div>
  <script>
    // Intercept form submission and render the server-sent events
    document.getElementById('owlsForm').addEventListener('submit', function(e) {
        e.preventDefault(); // Prevents default form submission
        var formData = new FormData(this);
        submitForm(formData);
    });

    let detections = [];

    function submitForm(formData) {
        document.getElementById('results').innerHTML = 'Chunking audio file...';

        fetch('/stream_predict', {
            method: 'POST',
            body: formData,
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            document.getElementById('results').innerHTML = '';
            return response.body;
        })
        .then(stream => {
            // Handle the stream
            const reader = stream.getReader();
            readStream(reader);
        })
        .catch(error => {
            console.error('Error:', error);
        });
    }

    function renderDetections() {
        let results = document.getElementById('results')
        results.innerHTML = '';
        detections.forEach(detection => {
            if (detection.detected) {
                results.innerHtml += "<p style='color: green'>"
                } else {
                results.innerHtml += "<p style='color: red'>"
                }
            results.innerHTML += JSON.stringify(detection) + "</p>";
        });
    }

    function readStream(reader) {
        reader.read().then(({ done, value }) => {
            if (done) {
                console.log('Stream complete');
                document.getElementById('results').innerHTML += "<p>Done processing!</p>";
                return;
            }
            // Process the chunk (value)
            const decoder = new TextDecoder();
            const text = decoder.decode(value);

            try {
                const jsonObj = JSON.parse(text);
                detections.push(jsonObj);
            } catch (e) {
                console.error("Error parsing JSON:", e);
            }

            detections = mergeEvents(detections);
            renderDetections(detections)

            console.log(text);
            // Read the next chunk
            readStream(reader);
        });
    }

    function mergeEvents(events) {
        let mergedEvents = [];
        let currentEvent = null;

        events.forEach(event => {
            // Check if we have a current event to possibly merge with
            if (currentEvent) {
                // Check if the current event can be merged with this one
                if (currentEvent.detected === event.detected && currentEvent.end_time === event.start_time) {
                    // Merge this event by extending the end_time of the current event
                    currentEvent.end_time = event.end_time;
                } else {
                    // The current event cannot be merged; add it to the mergedEvents and start a new current event
                    mergedEvents.push(currentEvent);
                    currentEvent = event;
                }
            } else {
                // This is the first event or after a non-mergeable event
                currentEvent = event;
            }
        });

        // Don't forget to add the last event if it exists
        if (currentEvent) {
            mergedEvents.push(currentEvent);
        }

        return mergedEvents;
    }

  </script>
  </body>
</html>